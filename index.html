<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formul√°rio de Pedido - Mundo Carol</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #d63384;
            --primary-dark: #c22574;
            --secondary: #6c757d;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --light: #f8f9fa;
            --dark: #343a40;
            --border: #dee2e6;
            --gray: #6c757d;
            --bg-light: #f8f9fa;
            --whatsapp: #25D366;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            min-height: 100vh;
            padding: 10px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-bottom: 3px solid var(--primary);
        }
        
        .header h1 {
            color: var(--primary);
            font-size: 22px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .header p {
            color: var(--gray);
            font-size: 14px;
        }
        
        .form-page {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-page.active {
            display: block;
        }
        
        .section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .section-title {
            color: var(--primary);
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .section-title i {
            font-size: 18px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #444;
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: white;
            -webkit-appearance: none;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(214, 51, 132, 0.1);
        }
        
        .form-control:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #e9ecef;
        }
        
        .radio-group {
            margin: 15px 0;
        }
        
        .radio-group p {
            font-weight: 600;
            margin-bottom: 12px;
            color: #444;
            font-size: 14px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .radio-option:hover {
            border-color: var(--primary);
            background: rgba(214, 51, 132, 0.03);
        }
        
        .radio-option input {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            cursor: pointer;
        }
        
        .radio-option label {
            cursor: pointer;
            flex: 1;
            font-size: 15px;
            margin: 0;
            font-weight: 500;
        }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 13px;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .alert-info {
            background: #e8f4fd;
            border: 1px solid #b6e0fe;
            color: #0c5460;
        }
        
        .btn {
            display: inline-block;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(214, 51, 132, 0.3);
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-whatsapp {
            background: var(--whatsapp);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 16px;
            padding: 14px;
            margin: 20px 0;
            width: 100%;
        }
        
        .btn-whatsapp:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
        }
        
        .btn-disabled {
            background: #adb5bd;
            cursor: not-allowed;
        }
        
        .btn-disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            justify-content: space-between;
        }
        
        .nav-buttons .btn {
            flex: 1;
            max-width: 48%;
        }
        
        .hidden {
            display: none !important;
        }
        
        .calendar-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .calendar-nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .calendar-month-year {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
            text-align: center;
            flex: 1;
            order: 2;
        }
        
        .calendar-nav {
            background: white;
            border: 2px solid var(--border);
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .calendar-nav:hover {
            border-color: var(--primary);
            background: rgba(214, 51, 132, 0.05);
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            padding: 8px 0;
            color: var(--gray);
            font-size: 12px;
        }
        
        .calendar-day {
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px 0;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            position: relative;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .calendar-day:hover:not(.disabled) {
            border-color: var(--primary);
            background: rgba(214, 51, 132, 0.05);
        }
        
        .calendar-day.disabled {
            background: #f8f9fa;
            color: #adb5bd;
            cursor: not-allowed;
            border-color: #e9ecef;
        }
        
        .calendar-day.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .calendar-day.special-day {
            border-color: #ffc107;
            background: #fff3cd;
        }
        
        .calendar-day.special-day::after {
            content: "‚ù§";
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 8px;
        }
        
        .time-options {
            margin-top: 15px;
        }
        
        .time-option {
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .time-option:hover:not(.disabled) {
            border-color: var(--primary);
            background: rgba(214, 51, 132, 0.03);
        }
        
        .time-option.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .time-option.disabled {
            background: #f8f9fa;
            color: #adb5bd;
            cursor: not-allowed;
            border-color: #e9ecef;
        }
        
        .time-option.disabled label {
            cursor: not-allowed;
        }
        
        .checkbox-confirm {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid var(--border);
        }
        
        .checkbox-confirm label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 600;
            margin: 0;
            font-size: 14px;
        }
        
        .checkbox-confirm input {
            width: 18px;
            height: 18px;
            margin-right: 10px;
        }
        
        .status-box {
            padding: 12px 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .spinner {
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top: 3px solid var(--primary);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .review-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        
        .review-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .review-label {
            font-weight: 600;
            color: var(--gray);
            flex: 1;
        }
        
        .review-value {
            font-weight: 500;
            text-align: right;
            flex: 1;
        }
        
        .total-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .total-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #ddd;
            font-size: 14px;
        }
        
        .total-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .total-final {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-top: 10px;
        }
        
        .payment-details {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            margin: 20px 0;
        }
        
        .pix-key-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 15px 0;
            border: 2px dashed var(--primary);
        }
        
        .pix-key {
            background: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            margin: 15px 0;
            border: 2px solid var(--border);
            word-break: break-all;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .pix-key:hover {
            background: #f8f9fa;
        }
        
        .instructions {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid var(--success);
        }
        
        .instructions h3 {
            color: var(--success);
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .success-page {
            text-align: center;
            padding: 20px;
        }
        
        .success-icon {
            font-size: 60px;
            color: var(--success);
            margin-bottom: 15px;
        }
        
        .success-title {
            color: var(--success);
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .success-subtitle {
            color: var(--gray);
            font-size: 16px;
            margin-bottom: 25px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .info-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary);
        }
        
        .info-card h3 {
            color: var(--primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }
        
        .frete-display {
            font-size: 13px;
            color: var(--gray);
            margin-top: 5px;
            text-align: right;
        }
        
        .frete-value {
            font-weight: 600;
            color: var(--success);
        }
        
        .link-generator {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }
        
        .copy-btn {
            background: var(--secondary);
            color: white;
            margin-top: 10px;
            padding: 10px 15px;
        }
        
        .copy-btn:hover {
            background: #5a6268;
        }
        
        .schedule-info {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }
        
        .schedule-info h3 {
            color: #856404;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }
        
        .schedule-item {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #ffeaa7;
            font-size: 14px;
        }
        
        .schedule-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .schedule-day {
            font-weight: 600;
            color: #856404;
        }
        
        .schedule-time {
            color: #333;
        }
        
        .preview-notice {
            background-color: #e8f5e9;
            border-left: 4px solid #28a745;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            font-size: 13px;
            color: #155724;
        }
        
        .preview-notice strong {
            color: #28a745;
        }
        
        .link-instructions {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            font-size: 13px;
            color: #0d47a1;
        }
        
        .generated-link-container {
            margin-top: 15px;
        }
        
        .generated-link {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            word-break: break-all;
            font-size: 13px;
            border: 1px solid #dee2e6;
            text-align: left;
            margin-bottom: 10px;
        }
        
        .whatsapp-discreto {
            background: white;
            border: 2px solid var(--whatsapp);
            color: var(--whatsapp);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 15px auto;
            width: auto;
            min-width: 200px;
            transition: all 0.3s;
        }
        
        .whatsapp-discreto:hover {
            background: var(--whatsapp);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
        }
        
        .taxa-item {
            color: #dc3545;
            font-weight: 600;
        }
        
        .taxa-label {
            color: #dc3545;
        }
        
        .admin-mode-badge {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 10px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .expired-message {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        
        .expired-message h3 {
            color: #721c24;
            margin-bottom: 10px;
        }
        
        .payment-option-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary);
        }
        
        .payment-option-card h3 {
            color: var(--primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }
        
        .discount-field {
            background: #e8f5e9;
            border-left: 4px solid #28a745;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
        }
        
        .discount-field label {
            color: #155724;
            font-weight: 600;
        }
        
        .discount-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }
            
            .form-page {
                padding: 15px;
            }
            
            .calendar-day {
                padding: 8px 0;
                font-size: 12px;
                min-height: 35px;
            }
            
            .calendar-nav-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .calendar-nav {
                order: 3;
                margin-top: 5px;
            }
            
            .calendar-month-year {
                order: 1;
            }
            
            .pix-key {
                font-size: 16px;
                padding: 12px;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 15px;
            }
            
            .nav-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .nav-buttons .btn {
                max-width: 100%;
            }
            
            .review-item {
                flex-direction: column;
                gap: 5px;
            }
            
            .review-label, .review-value {
                text-align: left;
                width: 100%;
            }
        }
        
        @media (min-width: 768px) {
            .container {
                max-width: 700px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Cabe√ßalho -->
        <div class="header">
            <h1><i class="fas fa-gift"></i> Formul√°rio de Pedido</h1>
            <p>Preencha os dados abaixo para realizar seu pedido</p>
        </div>
        
        <!-- Modo Administrador -->
        <div id="adminModeBadge" class="admin-mode-badge hidden">
            <i class="fas fa-user-shield"></i> MODO VENDEDOR
        </div>
        
        <!-- Mensagem de Link Expirado -->
        <div id="expiredMessage" class="expired-message hidden">
            <h3><i class="fas fa-exclamation-triangle"></i> LINK EXPIRADO</h3>
            <p>Este link de pedido expirou ou j√° foi utilizado.</p>
            <p>Entre em contato com o vendedor para receber um novo link.</p>
            <button class="btn btn-primary" onclick="resetToAdminMode()">
                <i class="fas fa-redo"></i> Voltar para Modo Vendedor
            </button>
        </div>
        
        <!-- Status de Envio -->
        <div id="sendStatus" class="status-box hidden"></div>
        
        <!-- P√°gina 1: Produto e Dados B√°sicos -->
        <div id="page1" class="form-page active">
            <div class="section">
                <h2 class="section-title"><i class="fas fa-box"></i> Produto Escolhido</h2>
                
                <div class="form-group">
                    <label for="productName">Nome do Produto:</label>
                    <input type="text" id="productName" class="form-control" placeholder="Digite o nome do produto" required>
                </div>
                
                <div class="form-group">
                    <label for="productPrice">Pre√ßo (R$):</label>
                    <input type="number" id="productPrice" class="form-control" min="0" step="0.01" placeholder="0,00" required>
                </div>
                
                <!-- Campo de Desconto (SOMENTE PARA VENDEDOR) -->
                <div id="discountField" class="discount-field">
                    <label for="productDiscount">Desconto (R$):</label>
                    <input type="number" id="productDiscount" class="form-control" min="0" step="0.01" placeholder="0,00" value="0">
                    <div class="discount-info">Digite o valor do desconto que ser√° aplicado ao gerar o link para o cliente.</div>
                </div>
                
                <!-- Se√ß√£o de pr√©-visualiza√ß√£o (SOMENTE PARA CLIENTE) -->
                <div id="previewNotice" class="preview-notice hidden">
                    <p><strong>‚úì Produto pr√©-selecionado:</strong> O produto j√° foi escolhido pelo vendedor.</p>
                    <p style="font-size: 11px; margin-top: 3px;">
                        <i class="fas fa-lock"></i> Produto bloqueado para edi√ß√£o
                    </p>
                </div>
                
                <div class="alert alert-info">
                    <p><strong>Frete ser√° calculado ap√≥s escolha do seu endere√ßo e aparecer√° ao final para confer√™ncia.</strong></p>
                </div>
                
                <!-- Gerador de Link (SOMENTE PARA VENDEDOR) -->
                <div id="linkGeneratorSection">
                    <div class="link-instructions">
                        <p><strong>üìã Para enviar para cliente:</strong> Preencha acima e clique em "Gerar Link"</p>
                    </div>
                    <button type="button" class="btn btn-primary" id="generateLinkBtn">Gerar Link para Cliente</button>
                    
                    <div id="generatedLinkContainer" class="generated-link-container hidden">
                        <h3 class="section-title">Link para Compartilhar:</h3>
                        <div id="generatedLink" class="generated-link"></div>
                        <button type="button" id="copyLinkBtn" class="btn copy-btn">
                            <i class="fas fa-copy"></i> Copiar Link
                        </button>
                        
                        <div class="alert alert-info" style="margin-top: 10px;">
                            <p><strong>üìù Instru√ß√µes:</strong></p>
                            <p>1. Copie o link acima</p>
                            <p>2. Envie para o cliente via WhatsApp</p>
                            <p>3. O link expira automaticamente ap√≥s 24 horas ou ap√≥s ser usado</p>
                            <p>4. Para novo pedido, gere sempre um novo link</p>
                        </div>
                        
                        <p class="success hidden" id="copySuccess" style="color: var(--success); font-weight: 600; text-align: center; margin-top: 10px;">
                            ‚úÖ Link copiado com sucesso!
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title"><i class="fas fa-user"></i> Dados do Comprador</h2>
                
                <div class="form-group">
                    <label for="buyerName">Nome do Comprador:</label>
                    <input type="text" id="buyerName" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="buyerPhone">Telefone:</label>
                    <input type="text" id="buyerPhone" class="form-control" placeholder="(XX) XXXXX-XXXX" required>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title"><i class="fas fa-user-check"></i> Dados do Presenteado</h2>
                
                <div class="alert alert-warning">
                    <p><strong>Aten√ß√£o:</strong> Preencha nome e telefone da pessoa presenteada apenas se o presente for para ela. Se for para voc√™ (comprador), repita seus dados. N√£o queremos estragar surpresas!</p>
                </div>
                
                <div class="form-group">
                    <label for="giftedName">Nome da Pessoa Presenteada:</label>
                    <input type="text" id="giftedName" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="giftedPhone">Telefone do Presenteado:</label>
                    <input type="text" id="giftedPhone" class="form-control" placeholder="(XX) XXXXX-XXXX">
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title"><i class="fas fa-eye-slash"></i> Confidencialidade</h2>
                <div class="radio-group">
                    <p>Quer seu nome aparecendo no seu Pedido?</p>
                    <div class="radio-option">
                        <input type="radio" name="anonymous" id="anonymousNo" value="no">
                        <label for="anonymousNo">Sim, sem problemas</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="anonymous" id="anonymousYes" value="yes">
                        <label for="anonymousYes">Quero uma compra An√¥nima</label>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title"><i class="fas fa-truck"></i> Tipo de Entrega</h2>
                <div class="radio-group">
                    <p>Confirme se ser√° entrega ou Retirada na Loja</p>
                    <div class="radio-option">
                        <input type="radio" name="deliveryType" id="delivery" value="delivery">
                        <label for="delivery">Quero que envie para o endere√ßo que vou fornecer</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="deliveryType" id="pickup" value="pickup">
                        <label for="pickup">Vou retirar na loja (Bairro S√£o Geraldo - BH)</label>
                    </div>
                </div>
            </div>
            
            <div class="nav-buttons">
                <button type="button" class="btn btn-secondary" onclick="prevPage(1, 1)" style="display: none;"><i class="fas fa-arrow-left"></i> Voltar</button>
                <button type="button" class="btn btn-primary" onclick="nextPage(1, 2)">Pr√≥xima P√°gina <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
        
        <!-- P√°gina 2: Endere√ßo e Data -->
        <div id="page2" class="form-page">
            <div id="citySection" class="section">
                <h2 class="section-title"><i class="fas fa-map-marker-alt"></i> Endere√ßo de Entrega</h2>
                
                <div class="form-group">
                    <label for="deliveryCity">Para qual cidade enviaremos seu pedido?</label>
                    <select id="deliveryCity" class="form-control" required>
                        <option value="">Selecione sua cidade</option>
                        <option value="Belo Horizonte">Belo Horizonte</option>
                        <option value="Betim">Betim</option>
                        <option value="Contagem">Contagem</option>
                        <option value="Sabar√°">Sabar√°</option>
                        <option value="Ibirit√©">Ibirit√©</option>
                        <option value="Ribeir√£o das Neves">Ribeir√£o das Neves</option>
                        <option value="Santa Luzia">Santa Luzia</option>
                        <option value="Vespasiano">Vespasiano</option>
                        <option value="Lagoa Santa">Lagoa Santa</option>
                        <option value="Nova Lima">Nova Lima</option>
                        <option value="other">Outra Localidade ou Cidade</option>
                    </select>
                    <div id="shippingInfo" class="frete-display hidden">
                        <span>Frete: <span id="freteValue" class="frete-value"></span></span>
                    </div>
                </div>
                
                <div id="addressFields">
                    <div class="form-group">
                        <label for="streetNumber">Rua e N√∫mero:</label>
                        <input type="text" id="streetNumber" class="form-control" placeholder="Ex: Rua das Flores, 123" required>
                        <small>Informe a rua e n√∫mero juntos</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="complement">Complemento (ap/bloco/loja/etc):</label>
                        <input type="text" id="complement" class="form-control">
                        <small>Se n√£o tem complemento, pode deixar em branco</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="neighborhood">Bairro:</label>
                        <input type="text" id="neighborhood" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="referencePoint">Ponto de refer√™ncia (opcional):</label>
                        <input type="text" id="referencePoint" class="form-control">
                    </div>
                </div>
            </div>
            
            <div id="calendarSection" class="section">
                <h2 class="section-title"><i class="fas fa-calendar-alt"></i> Data de Entrega</h2>
                
                <div id="otherCityMessage" class="alert alert-info hidden">
                    <h3><i class="fas fa-truck-loading"></i> Entrega para Outra Cidade</h3>
                    <p>Ao escolher <strong>Outra Localidade ou Cidade</strong>, por n√£o ser entrega pr√≥pria o prazo ser√° informado por um de nossos atendentes.</p>
                    <p>Os envios s√£o feitos por Correios e Transportadoras, portanto temos prazos aproximados, mas n√£o temos entregas agendadas.</p>
                    <p>Ap√≥s a confirma√ß√£o do pagamento, nossa equipe entrar√° em contato para informar o prazo de entrega estimado.</p>
                </div>
                
                <div id="calendarContainer" class="calendar-container">
                    <div class="calendar-nav-container">
                        <span class="calendar-nav" id="prevMonth"><i class="fas fa-chevron-left"></i> M√™s Anterior</span>
                        <span id="currentMonthYear" class="calendar-month-year"></span>
                        <span class="calendar-nav" id="nextMonth">Pr√≥ximo M√™s <i class="fas fa-chevron-right"></i></span>
                    </div>
                    <div id="calendar" class="calendar"></div>
                </div>
                
                <div id="noDeliveryMessage" class="alert alert-warning hidden">
                    <p><strong>Nesse dia n√£o teremos entregas.</strong> Selecione outro dia para conseguir agendar seu pedido.</p>
                    <button type="button" class="btn btn-secondary" onclick="resetCalendar()">Voltar para op√ß√µes</button>
                </div>
                
                <div id="timeOptions" class="time-options hidden">
                    <h3 class="section-title"><i class="fas fa-clock"></i> Hor√°rios Dispon√≠veis</h3>
                    <div id="deliveryOptionsContainer"></div>
                </div>
            </div>
            
            <div class="nav-buttons">
                <button type="button" class="btn btn-secondary" onclick="prevPage(2, 1)"><i class="fas fa-arrow-left"></i> P√°gina Anterior</button>
                <button type="button" class="btn btn-primary" onclick="nextPage(2, 3)" id="nextPage2Button" disabled>Pr√≥xima P√°gina <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
        
        <!-- P√°gina 3: Cart√£o de Mensagem -->
        <div id="page3" class="form-page">
            <div class="section">
                <h2 class="section-title"><i class="fas fa-envelope"></i> Cart√£o de Mensagem</h2>
                
                <div class="radio-group">
                    <p>Gostaria de Enviar um Cart√£o? (Sem custo adicional)</p>
                    <div class="radio-option">
                        <input type="radio" name="sendCard" value="yes" id="sendCardYes">
                        <label for="sendCardYes">Sim, quero enviar um cart√£o</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="sendCard" value="no" id="sendCardNo">
                        <label for="sendCardNo">N√£o, n√£o quero cart√£o</label>
                    </div>
                </div>
                
                <div id="cardMessageSection">
                    <div class="form-group">
                        <label for="cardMessage">Escreva o Texto do seu Cart√£o:</label>
                        <textarea id="cardMessage" class="form-control" rows="5" placeholder="Digite sua mensagem aqui..."></textarea>
                    </div>
                    
                    <div class="radio-group">
                        <p>Voc√™ lembrou de assinar seu cart√£o na mensagem acima?</p>
                        <div class="radio-option">
                            <input type="radio" name="signedCard" value="yes" id="signedCardYes">
                            <label for="signedCardYes">Sim, assinei</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" name="signedCard" value="no" id="signedCardNo">
                            <label for="signedCardNo">N√£o, n√£o quero assinar</label>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <p><strong>Termo de Ci√™ncia:</strong> Todas as mensagens para o cart√£o n√£o podem ser corrigidas ou alteradas, por se tratar de algo particular. <strong>Ent√£o se atente √† gram√°tica.</strong></p>
                        <div class="radio-option">
                            <input type="radio" name="acknowledgeTerms" value="yes" id="acknowledgeTermsYes">
                            <label for="acknowledgeTermsYes">Sim, estou ciente e concordo</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="nav-buttons">
                <button type="button" class="btn btn-secondary" onclick="prevPage(3, 2)"><i class="fas fa-arrow-left"></i> P√°gina Anterior</button>
                <button type="button" class="btn btn-primary" onclick="nextPage(3, 4)">Pr√≥xima P√°gina <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
        
        <!-- P√°gina 4: Pagamento e Revis√£o -->
        <div id="page4" class="form-page">
            <div class="section">
                <h2 class="section-title"><i class="fas fa-credit-card"></i> Forma de Pagamento</h2>
                
                <div class="radio-group">
                    <p>Como gostaria de finalizar o pagamento do seu pedido?</p>
                    <div class="radio-option">
                        <input type="radio" name="paymentMethod" value="pix" id="paymentPix">
                        <label for="paymentPix">PIX direto para nosso CNPJ (Libera√ß√£o imediata)</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="paymentMethod" value="creditCard" id="paymentCreditCard">
                        <label for="paymentCreditCard">Link de Cart√£o de Cr√©dito online (enviaremos o link)</label>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title"><i class="fas fa-search"></i> Como nos encontrou?</h2>
                
                <div class="radio-group">
                    <p>Nos ajude a melhorar cada vez mais!</p>
                    <div class="radio-option">
                        <input type="radio" name="foundUs" value="google" id="foundUsGoogle">
                        <label for="foundUsGoogle">Google</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="foundUs" value="instagram" id="foundUsInstagram">
                        <label for="foundUsInstagram">Instagram</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="foundUs" value="facebook" id="foundUsFacebook">
                        <label for="foundUsFacebook">Facebook</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="foundUs" value="indicacao" id="foundUsIndicacao">
                        <label for="foundUsIndicacao">Indica√ß√£o de amigo/familiar</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="foundUs" value="cliente_antigo" id="foundUsClienteAntigo">
                        <label for="foundUsClienteAntigo">J√° sou cliente antigo</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="foundUs" value="outro" id="foundUsOutro">
                        <label for="foundUsOutro">Outro</label>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title"><i class="fas fa-clipboard-check"></i> Revise seu Pedido</h2>
                
                <div id="reviewData"></div>
                
                <div id="finalTotalSection" class="total-section hidden">
                    <h3 class="section-title"><i class="fas fa-receipt"></i> Resumo Financeiro</h3>
                    <div id="finalTotalDetails"></div>
                </div>
                
                <div class="alert alert-info">
                    <p><strong>Ap√≥s enviar seus dados, aparecer√£o as informa√ß√µes para pagamento.</strong></p>
                </div>
                
                <div class="checkbox-confirm">
                    <label>
                        <input type="checkbox" id="confirmData">
                        <span>Revisei e confirmo que todos os dados est√£o corretos</span>
                    </label>
                </div>
                
                <!-- Status de Envio -->
                <div class="loading" id="loadingSection">
                    <div class="spinner"></div>
                    <p>Enviando dados para a planilha...</p>
                </div>
                
                <div id="statusBox" class="status-box"></div>
            </div>
            
            <div class="nav-buttons">
                <button type="button" class="btn btn-secondary" onclick="prevPage(4, 3)"><i class="fas fa-arrow-left"></i> P√°gina Anterior</button>
                <button type="button" class="btn btn-primary" onclick="submitForm()" id="submitButton" disabled>Enviar Pedido <i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        
        <!-- P√°gina de Sucesso PIX -->
        <div id="thankYouPagePix" class="form-page">
            <div class="success-page">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                
                <h1 class="success-title">PEDIDO ENVIADO COM SUCESSO!</h1>
                <p class="success-subtitle">Seus dados foram registrados e enviados para nossa equipe. Agora √© s√≥ finalizar o pagamento!</p>
                
                <div class="payment-details">
                    <h2 class="section-title"><i class="fas fa-qrcode"></i> Pagamento via PIX</h2>
                    
                    <div class="pix-key-container">
                        <p>Para pagamento imediato, utilize nossa chave PIX (CNPJ):</p>
                        <div class="pix-key" id="pixKey" onclick="selectPixKey()">10648303000179</div>
                        <button type="button" class="btn btn-primary" onclick="copyPixKey()">
                            <i class="fas fa-copy"></i> Copiar Chave PIX
                        </button>
                    </div>
                    
                    <div id="paymentSummary" class="info-card">
                        <h3><i class="fas fa-file-invoice-dollar"></i> Resumo do Pedido</h3>
                        <div id="paymentDetailsPix"></div>
                    </div>
                    
                    <!-- Bot√£o WhatsApp discreto -->
                    <button class="whatsapp-discreto" onclick="sendWhatsAppMessage()">
                        <i class="fab fa-whatsapp"></i> WhatsApp: (31) 98323-8087
                    </button>
                    
                    <div class="schedule-info">
                        <h3><i class="fas fa-clock"></i> Hor√°rio de Atendimento</h3>
                        <div class="schedule-item">
                            <span class="schedule-day">Segunda a Sexta:</span>
                            <span class="schedule-time">07:30 √†s 17:30</span>
                        </div>
                        <div class="schedule-item">
                            <span class="schedule-day">S√°bado e Feriados:</span>
                            <span class="schedule-time">07:30 √†s 12:00</span>
                        </div>
                        <div class="schedule-item">
                            <span class="schedule-day">Domingo:</span>
                            <span class="schedule-time">N√£o temos atendimentos aos domingos, apenas entregas das cestas encomendadas at√© s√°bado 12 horas</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- P√°gina de Sucesso CART√ÉO -->
        <div id="thankYouPageCard" class="form-page">
            <div class="success-page">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                
                <h1 class="success-title">PEDIDO ENVIADO COM SUCESSO!</h1>
                <p class="success-subtitle">Seus dados foram registrados e enviados para nossa equipe. Em breve voc√™ receber√° o link de pagamento!</p>
                
                <div class="payment-details">
                    <div class="payment-option-card">
                        <h3><i class="fas fa-credit-card"></i> Pagamento via Cart√£o de Cr√©dito</h3>
                        <div class="alert alert-info" style="margin: 15px 0;">
                            <p><strong>Voc√™ escolheu pagar via Cart√£o de Cr√©dito.</strong></p>
                            <p>Nosso atendente enviar√° para voc√™ um link seguro de pagamento via WhatsApp em breve.</p>
                            <p>Fique atento(a) √†s mensagens do WhatsApp!</p>
                        </div>
                        
                        <div class="info-card" style="background: #f8f9fa; margin-top: 20px;">
                            <h3><i class="fas fa-file-invoice-dollar"></i> Resumo do Pedido</h3>
                            <div id="paymentDetailsCard"></div>
                        </div>
                        
                        <div class="alert alert-warning" style="margin-top: 20px;">
                            <p><strong>Alternativa: Pagamento via PIX</strong></p>
                            <p>Se preferir pagar agora via PIX, utilize nossa chave abaixo:</p>
                            <div class="pix-key" style="font-size: 16px; padding: 10px; margin: 10px 0;" onclick="selectPixKey()">10648303000179</div>
                            <button type="button" class="btn btn-secondary" onclick="copyPixKey()" style="width: 100%;">
                                <i class="fas fa-copy"></i> Copiar Chave PIX
                            </button>
                        </div>
                    </div>
                    
                    <!-- Bot√£o WhatsApp discreto -->
                    <button class="whatsapp-discreto" onclick="sendWhatsAppMessage()">
                        <i class="fab fa-whatsapp"></i> WhatsApp: (31) 98323-8087
                    </button>
                    
                    <div class="schedule-info">
                        <h3><i class="fas fa-clock"></i> Hor√°rio de Atendimento</h3>
                        <div class="schedule-item">
                            <span class="schedule-day">Segunda a Sexta:</span>
                            <span class="schedule-time">07:30 √†s 17:30</span>
                        </div>
                        <div class="schedule-item">
                            <span class="schedule-day">S√°bado e Feriados:</span>
                            <span class="schedule-time">07:30 √†s 12:00</span>
                        </div>
                        <div class="schedule-item">
                            <span class="schedule-day">Domingo:</span>
                            <span class="schedule-time">N√£o temos atendimentos aos domingos, apenas entregas das cestas encomendadas at√© s√°bado 12 horas</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURA√á√ïES DO SISTEMA
        // ============================================
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwAM8V_xQ8uxdcmfANaeKTgUDRZtZI9tcXOnm0ou0mnUWwsh3GOT5WJk9GztSiQevEN/exec';
        const CORRECT_PASSWORD = '562938';
        const PIX_KEY = '10648303000179';
        const WHATSAPP_NUMBER = '5531983238087';
        
        // ============================================
        // VARI√ÅVEIS GLOBAIS
        // ============================================
        let selectedDate = null;
        let selectedTime = null;
        let selectedTimeLabel = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let specialDates = ['03-08', '06-12', '12-25'];
        let holidays = [];
        let avulsoDates = [];
        let noDeliveryDates = [];
        let originalTotal = 0;
        let nightFeeAdded = false;
        let nightFeeAmount = 0;
        let isOtherCity = false;
        let calculatedShipping = 0;
        let selectedCity = '';
        let isSubmitting = false;
        let currentDeliveryType = '';
        let isAdminMode = true; // Sempre come√ßa em modo administrador
        let linkExpirationTime = 24 * 60 * 60 * 1000; // 24 horas em milissegundos
        let clientDiscount = 0; // Desconto para cliente
        
        // ============================================
        // TABELA DE FRETES
        // ============================================
        const shippingRates = {
            'Belo Horizonte': [
                { min: 1, max: 119.99, cost: 19.90 },
                { min: 120, max: 179.99, cost: 14.90 },
                { min: 180, max: 99999, cost: 0.00 }
            ],
            'Betim': [
                { min: 1, max: 119.99, cost: 69.90 },
                { min: 120, max: 179.99, cost: 54.90 },
                { min: 180, max: 99999, cost: 44.90 }
            ],
            'Contagem': [
                { min: 1, max: 119.99, cost: 29.90 },
                { min: 120, max: 179.99, cost: 24.90 },
                { min: 180, max: 99999, cost: 19.90 }
            ],
            'Sabar√°': [
                { min: 1, max: 119.99, cost: 29.90 },
                { min: 120, max: 179.99, cost: 26.90 },
                { min: 180, max: 99999, cost: 22.90 }
            ],
            'Ibirit√©': [
                { min: 1, max: 119.99, cost: 69.90 },
                { min: 120, max: 179.99, cost: 59.90 },
                { min: 180, max: 99999, cost: 44.90 }
            ],
            'Ribeir√£o das Neves': [
                { min: 1, max: 119.99, cost: 59.90 },
                { min: 120, max: 179.99, cost: 54.90 },
                { min: 180, max: 99999, cost: 44.90 }
            ],
            'Santa Luzia': [
                { min: 1, max: 119.99, cost: 49.90 },
                { min: 120, max: 179.99, cost: 44.90 },
                { min: 180, max: 99999, cost: 39.90 }
            ],
            'Vespasiano': [
                { min: 1, max: 119.99, cost: 59.90 },
                { min: 120, max: 179.99, cost: 49.90 },
                { min: 180, max: 99999, cost: 39.90 }
            ],
            'Lagoa Santa': [
                { min: 1, max: 119.99, cost: 59.90 },
                { min: 120, max: 179.99, cost: 54.90 },
                { min: 180, max: 99999, cost: 44.90 }
            ],
            'Nova Lima': [
                { min: 1, max: 119.99, cost: 69.90 },
                { min: 120, max: 179.99, cost: 59.90 },
                { min: 180, max: 99999, cost: 49.90 }
            ]
        };
        
        // ============================================
        // HOR√ÅRIOS
        // ============================================
        const routeTimes = {
            weekday: [
                { start: '07:30', end: '09:30', label: '07:30 √†s 09:30' },
                { start: '09:30', end: '11:30', label: '09:30 √†s 11:30' },
                { start: '13:30', end: '15:30', label: '13:30 √†s 15:30' },
                { start: '15:30', end: '17:30', label: '15:30 √†s 17:30' },
                { start: '19:30', end: '21:30', label: '19:30 √†s 21:30 (taxa noturna adicional 19,90)', nightFee: true, fee: 19.90 }
            ],
            saturday: [
                { start: '07:30', end: '10:30', label: '07:30 √†s 10:30' },
                { start: '10:30', end: '12:30', label: '10:30 √†s 12:30' },
                { start: '12:30', end: '16:30', label: '12:30 √†s 16:30' }
            ],
            sunday: [
                { start: '08:00', end: '10:00', label: '08:00 √†s 10:00 (taxa adicional 19,90)', sundayFee: true, fee: 19.90 }
            ],
            special: [
                { start: '07:30', end: '12:30', label: '07:30 √†s 12:30' },
                { start: '13:30', end: '18:30', label: '13:30 √†s 18:30' },
                { start: '19:30', end: '21:30', label: '19:30 √†s 21:30 (taxa noturna 19,90)', nightFee: true, fee: 19.90 }
            ],
            avulso: [
                { start: '08:00', end: '12:00', label: '08:00 √†s 12:00' },
                { start: '13:00', end: '17:00', label: '13:00 √†s 17:00' },
                { start: '18:00', end: '21:00', label: '18:00 √†s 21:00 (taxa adicional 29,90)', avulsoNightFee: true, fee: 29.90 }
            ]
        };
        
    // ============================================
// INICIALIZA√á√ÉO
// ============================================
document.addEventListener('readystatechange', function() {
    if (document.readyState === 'complete') {
        console.log('üöÄ Sistema de Pedidos inicializado');
        
        // Verificar se veio de um link compartilhado
        checkSharedLink();
        
        // Configurar modo administrador (sempre come√ßa assim)
        setupAdminMode();
        
        // Configurar eventos
        setupEventListeners();
        
        // Carregar dados salvos (apenas para modo admin)
        loadSavedData();
        
        // Renderizar calend√°rio inicial
        renderCalendar(currentMonth, currentYear);
        
        // Limpar pedidos expirados
        cleanupExpiredLinks();
    }
});
        // ============================================
        // VERIFICA√á√ÉO DE LINK COMPARTILHADO
        // ============================================
        function checkSharedLink() {
            const hash = window.location.hash.substring(1);
            
            if (!hash) {
                // Sem hash = modo administrador
                isAdminMode = true;
                return;
            }
            
            try {
                const params = new URLSearchParams(hash);
                const product = params.get('product');
                const price = params.get('price');
                const discount = params.get('discount');
                const timestamp = params.get('t');
                const orderId = params.get('id');
                
                // Verificar se √© um link v√°lido
                if (product && price && timestamp && orderId) {
                    // Verificar se o link expirou (24 horas)
                    const linkTime = parseInt(timestamp);
                    const currentTime = Date.now();
                    
                    if (currentTime - linkTime > linkExpirationTime) {
                        // Link expirado
                        showExpiredMessage();
                        isAdminMode = false;
                        return;
                    }
                    
                    // Verificar se j√° foi usado (armazenado no localStorage)
                    const usedLinks = JSON.parse(localStorage.getItem('usedLinks') || '[]');
                    if (usedLinks.includes(orderId)) {
                        // Link j√° usado
                        showExpiredMessage();
                        isAdminMode = false;
                        return;
                    }
                    
                    // √â um link v√°lido! Mudar para modo cliente
                    isAdminMode = false;
                    setupClientMode(product, price, discount, orderId, linkTime);
                    
                } else {
                    // Hash inv√°lido, voltar para modo admin
                    isAdminMode = true;
                }
                
            } catch (e) {
                console.error('Erro ao processar link:', e);
                isAdminMode = true;
            }
        }
        
        function showExpiredMessage() {
            document.getElementById('expiredMessage').classList.remove('hidden');
            document.getElementById('page1').classList.add('hidden');
            document.getElementById('adminModeBadge').classList.add('hidden');
        }
        
        function resetToAdminMode() {
            // Limpar URL
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Resetar formul√°rio
            clearSavedData();
            
            // Mostrar modo admin
            document.getElementById('expiredMessage').classList.add('hidden');
            document.getElementById('page1').classList.remove('hidden');
            setupAdminMode();
            
            // Recarregar p√°gina para garantir estado limpo
            window.location.reload();
        }
        
        // ============================================
        // CONFIGURA√á√ÉO DOS MODOS
        // ============================================
        function setupAdminMode() {
            console.log('üîß Configurando modo Vendedor');
            
            // Mostrar badge
            document.getElementById('adminModeBadge').classList.remove('hidden');
            
            // Habilitar edi√ß√£o dos campos de produto
            document.getElementById('productName').disabled = false;
            document.getElementById('productPrice').disabled = false;
            document.getElementById('productDiscount').disabled = false;
            document.getElementById('discountField').style.display = 'block';
            
            // Mostrar se√ß√£o de gerar link
            document.getElementById('linkGeneratorSection').style.display = 'block';
            document.getElementById('previewNotice').classList.add('hidden');
            
            // Limpar formul√°rio
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productDiscount').value = '0';
            document.getElementById('buyerName').value = '';
            document.getElementById('buyerPhone').value = '';
            document.getElementById('giftedName').value = '';
            document.getElementById('giftedPhone').value = '';
            
            // Garantir que p√°gina 1 esteja ativa
            document.querySelectorAll('.form-page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('page1').classList.add('active');
        }
        
        function setupClientMode(product, price, discount, orderId, timestamp) {
            console.log('üë§ Configurando modo Cliente');
            
            // Esconder badge
            document.getElementById('adminModeBadge').classList.add('hidden');
            
            // Preencher produto (bloqueado para edi√ß√£o)
            document.getElementById('productName').value = decodeURIComponent(product);
            document.getElementById('productPrice').value = decodeURIComponent(price);
            
            // Aplicar desconto se existir
            if (discount) {
                clientDiscount = parseFloat(decodeURIComponent(discount)) || 0;
            }
            
            // Bloquear edi√ß√£o dos campos de produto
            document.getElementById('productName').disabled = true;
            document.getElementById('productPrice').disabled = true;
            
            // Esconder campo de desconto (s√≥ para vendedor)
            document.getElementById('discountField').style.display = 'none';
            
            // Esconder se√ß√£o de gerar link
            document.getElementById('linkGeneratorSection').style.display = 'none';
            
            // Mostrar aviso
            document.getElementById('previewNotice').classList.remove('hidden');
            
            // Calcular total
            calculateProductTotal();
            
            // Garantir que p√°gina 1 esteja ativa
            document.querySelectorAll('.form-page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('page1').classList.add('active');
            
            // Salvar ID do pedido para marcar como usado depois
            window.currentOrderId = orderId;
            window.linkTimestamp = timestamp;
        }
        
        // ============================================
        // GERADOR DE LINK (SOMENTE MODO ADMIN)
        // ============================================
        function generateClientLink() {
            const productName = document.getElementById('productName').value.trim();
            const productPrice = document.getElementById('productPrice').value.trim();
            const productDiscount = document.getElementById('productDiscount').value.trim() || '0';
            
            if (!productName || !productPrice) {
                alert('Por favor, preencha o nome e pre√ßo do produto antes de gerar o link.');
                return;
            }
            
            // Gerar ID √∫nico com timestamp
            const orderId = 'order_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const timestamp = Date.now();
            
            // Criar link com fragmento
            const baseUrl = window.location.origin + window.location.pathname;
            const encodedProductName = encodeURIComponent(productName);
            const encodedProductPrice = encodeURIComponent(productPrice);
            const encodedDiscount = encodeURIComponent(productDiscount);
            
            const clientLink = `${baseUrl}#product=${encodedProductName}&price=${encodedProductPrice}&discount=${encodedDiscount}&t=${timestamp}&id=${orderId}`;
            
            // Mostrar link
            document.getElementById('generatedLink').textContent = clientLink;
            document.getElementById('generatedLinkContainer').classList.remove('hidden');
            
            // Scroll para mostrar o link
            document.getElementById('generatedLinkContainer').scrollIntoView({ behavior: 'smooth' });
            
            // Mostrar instru√ß√µes
            alert(`‚úÖ Link gerado com sucesso!

üìã Instru√ß√µes:
1. Copie o link acima
2. Envie para o cliente via WhatsApp
3. O link expira automaticamente ap√≥s 24 horas
4. Ap√≥s o cliente preencher o formul√°rio, o link √© marcado como usado
5. Para novo pedido, gere sempre um novo link`);
            
            if (parseFloat(productDiscount) > 0) {
                alert(`üí∏ Desconto aplicado: R$ ${parseFloat(productDiscount).toFixed(2)}
O cliente ver√° o produto com pre√ßo original, mas o desconto ser√° aplicado automaticamente no c√°lculo final.`);
            }
        }
        
        function copyGeneratedLink() {
            const link = document.getElementById('generatedLink').textContent;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(link).then(() => {
                    document.getElementById('copySuccess').classList.remove('hidden');
                    setTimeout(() => {
                        document.getElementById('copySuccess').classList.add('hidden');
                    }, 3000);
                }).catch(err => {
                    copyUsingExecCommand(link);
                });
            } else {
                copyUsingExecCommand(link);
            }
        }
        
        function copyUsingExecCommand(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                document.getElementById('copySuccess').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('copySuccess').classList.add('hidden');
                }, 3000);
            } catch (err) {
                alert('‚ö†Ô∏è N√£o foi poss√≠vel copiar. Por favor, anote: ' + text);
            } finally {
                document.body.removeChild(textArea);
            }
        }
        
        function cleanupExpiredLinks() {
            const usedLinks = JSON.parse(localStorage.getItem('usedLinks') || '[]');
            const now = Date.now();
            
            // Manter apenas os √∫ltimos 100 links usados
            if (usedLinks.length > 100) {
                localStorage.setItem('usedLinks', JSON.stringify(usedLinks.slice(-100)));
            }
        }
        
        // ============================================
        // CONFIGURA√á√ÉO DE EVENTOS
        // ============================================
        function setupEventListeners() {
            // Configurar eventos da p√°gina 1
            document.getElementById('productPrice').addEventListener('input', calculateProductTotal);
            document.getElementById('productDiscount').addEventListener('input', saveData);
            
            // Configurar eventos da p√°gina 2
            document.getElementById('deliveryCity').addEventListener('change', function() {
                selectedCity = this.value;
                isOtherCity = this.value === 'other';
                updateCityDisplay();
                saveData();
            });
            
            // Configurar eventos do tipo de entrega
            document.querySelectorAll('input[name="deliveryType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentDeliveryType = this.value;
                    updateDeliveryTypeDisplay();
                    saveData();
                });
            });
            
            // Configurar calend√°rio
            document.getElementById('prevMonth').addEventListener('click', function() {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar(currentMonth, currentYear);
            });
            
            document.getElementById('nextMonth').addEventListener('click', function() {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar(currentMonth, currentYear);
            });
            
            // Configurar confirma√ß√£o
            document.getElementById('confirmData').addEventListener('change', function() {
                document.getElementById('submitButton').disabled = !this.checked;
                saveData();
            });
            
            // Event listeners para gerar link (somente admin)
            document.getElementById('generateLinkBtn').addEventListener('click', generateClientLink);
            document.getElementById('copyLinkBtn').addEventListener('click', copyGeneratedLink);
            
            // Inicializar tipo de entrega
            const deliveryTypeRadio = document.querySelector('input[name="deliveryType"]:checked');
            if (deliveryTypeRadio) {
                currentDeliveryType = deliveryTypeRadio.value;
                updateDeliveryTypeDisplay();
            }
        }
        
        // ============================================
        // FUN√á√ïES DE NAVEGA√á√ÉO
        // ============================================
        function nextPage(current, next) {
            if (current === 1 && !validatePage1()) return;
            if (current === 2 && !validatePage2()) return;
            if (current === 3 && !validatePage3()) return;
            if (current === 4 && !validatePage4()) return;
            
            if (next === 4) {
                updateReviewData();
            }
            
            document.getElementById(`page${current}`).classList.remove('active');
            document.getElementById(`page${next}`).classList.add('active');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            saveData();
        }
        
        function prevPage(current, prev) {
            document.getElementById(`page${current}`).classList.remove('active');
            document.getElementById(`page${prev}`).classList.add('active');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            saveData();
        }
        
        // ============================================
        // FUN√á√ïES DE VALIDA√á√ÉO
        // ============================================
        function validatePage1() {
            const required = [
                { id: 'productName', name: 'Nome do Produto' },
                { id: 'productPrice', name: 'Pre√ßo' },
                { id: 'buyerName', name: 'Nome do Comprador' },
                { id: 'buyerPhone', name: 'Telefone do Comprador' },
                { id: 'giftedName', name: 'Nome do Presenteado' }
            ];
            
            for (const field of required) {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                    alert(`Por favor, preencha: ${field.name}`);
                    element?.focus();
                    return false;
                }
            }
            
            if (!document.querySelector('input[name="anonymous"]:checked')) {
                alert('Por favor, informe se deseja compra an√¥nima.');
                return false;
            }
            
            if (!document.querySelector('input[name="deliveryType"]:checked')) {
                alert('Por favor, selecione o tipo de entrega.');
                return false;
            }
            
            return true;
        }
        
        function validatePage2() {
            const deliveryType = document.querySelector('input[name="deliveryType"]:checked')?.value;
            
            if (deliveryType === 'delivery') {
                const city = document.getElementById('deliveryCity').value;
                if (!city) {
                    alert('Por favor, selecione uma cidade.');
                    return false;
                }
                
                if (city !== 'other') {
                    const required = ['streetNumber', 'neighborhood'];
                    for (const field of required) {
                        const element = document.getElementById(field);
                        if (!element || !element.value.trim()) {
                            alert(`Por favor, preencha o campo: ${field === 'streetNumber' ? 'Rua e N√∫mero' : 'Bairro'}`);
                            element?.focus();
                            return false;
                        }
                    }
                }
                
                if (!isOtherCity && deliveryType === 'delivery') {
                    if (!selectedDate) {
                        alert('Por favor, selecione uma data de entrega.');
                        return false;
                    }
                    
                    if (!document.querySelector('input[name="deliveryTime"]:checked')) {
                        alert('Por favor, selecione um hor√°rio de entrega.');
                        return false;
                    }
                }
            }
            
            if (deliveryType === 'pickup') {
                if (!selectedDate) {
                    alert('Por favor, selecione uma data para retirada.');
                    return false;
                }
                
                if (!document.querySelector('input[name="deliveryTime"]:checked')) {
                    alert('Por favor, selecione um hor√°rio para retirada.');
                    return false;
                }
            }
            
            return true;
        }
        
        function validatePage3() {
            if (!document.querySelector('input[name="sendCard"]:checked')) {
                alert('Por favor, selecione se deseja enviar um cart√£o.');
                return false;
            }
            
            const sendCard = document.querySelector('input[name="sendCard"]:checked').value;
            if (sendCard === 'yes') {
                if (!document.getElementById('cardMessage').value.trim()) {
                    alert('Por favor, escreva a mensagem do cart√£o.');
                    document.getElementById('cardMessage').focus();
                    return false;
                }
                
                if (!document.querySelector('input[name="signedCard"]:checked')) {
                    alert('Por favor, informe se assinou o cart√£o.');
                    return false;
                }
            }
            
            if (!document.querySelector('input[name="acknowledgeTerms"]:checked')) {
                alert('Por favor, confirme o termo de ci√™ncia.');
                return false;
            }
            
            return true;
        }
        
        function validatePage4() {
            if (!document.querySelector('input[name="paymentMethod"]:checked')) {
                alert('Por favor, selecione a forma de pagamento.');
                return false;
            }
            
            if (!document.querySelector('input[name="foundUs"]:checked')) {
                alert('Por favor, nos informe como nos encontrou.');
                return false;
            }
            
            if (!document.getElementById('confirmData').checked) {
                alert('Por favor, confirme que revisou todos os dados.');
                return false;
            }
            
            return true;
        }
        
        // ============================================
        // FUN√á√ïES DE ATUALIZA√á√ÉO DE DISPLAY
        // ============================================
        function updateDeliveryTypeDisplay() {
            const deliveryType = document.querySelector('input[name="deliveryType"]:checked')?.value;
            const citySection = document.getElementById('citySection');
            const calendarSection = document.getElementById('calendarSection');
            
            if (deliveryType === 'pickup') {
                citySection.style.display = 'none';
                calendarSection.style.display = 'block';
                calculatedShipping = 0;
                selectedDate = null;
                selectedTime = null;
                isOtherCity = false;
            } else {
                citySection.style.display = 'block';
                calendarSection.style.display = 'block';
                
                if (selectedCity && selectedCity !== 'other') {
                    calculateShipping();
                }
            }
            
            const nextButton = document.getElementById('nextPage2Button');
            if (deliveryType === 'pickup') {
                nextButton.disabled = !(selectedDate && document.querySelector('input[name="deliveryTime"]:checked'));
            } else if (deliveryType === 'delivery' && isOtherCity) {
                nextButton.disabled = false;
            } else if (deliveryType === 'delivery') {
                nextButton.disabled = true;
            }
        }
        
        function updateCityDisplay() {
            const otherCityMessage = document.getElementById('otherCityMessage');
            const calendarContainer = document.getElementById('calendarContainer');
            const timeOptions = document.getElementById('timeOptions');
            const shippingInfo = document.getElementById('shippingInfo');
            const nextButton = document.getElementById('nextPage2Button');
            
            if (isOtherCity) {
                otherCityMessage.classList.remove('hidden');
                calendarContainer.classList.add('hidden');
                timeOptions.classList.add('hidden');
                shippingInfo.classList.add('hidden');
                calculatedShipping = 0;
                selectedDate = null;
                selectedTime = null;
                selectedTimeLabel = null;
                if (currentDeliveryType === 'delivery') {
                    nextButton.disabled = false;
                }
            } else {
                otherCityMessage.classList.add('hidden');
                calendarContainer.classList.remove('hidden');
                if (selectedCity && currentDeliveryType === 'delivery') {
                    shippingInfo.classList.remove('hidden');
                }
                nextButton.disabled = true;
                
                if (selectedCity && currentDeliveryType === 'delivery') {
                    calculateShipping();
                }
            }
        }
        
        // ============================================
        // FUN√á√ïES DE C√ÅLCULO
        // ============================================
        function calculateProductTotal() {
            const price = parseFloat(document.getElementById('productPrice').value) || 0;
            originalTotal = price;
            
            if (selectedCity && selectedCity !== 'other' && currentDeliveryType === 'delivery') {
                calculateShipping();
            }
            
            saveData();
        }
        
        function calculateShipping() {
            const price = parseFloat(document.getElementById('productPrice').value) || 0;
            const cityRates = shippingRates[selectedCity];
            
            if (cityRates) {
                for (const rate of cityRates) {
                    if (price >= rate.min && price <= rate.max) {
                        calculatedShipping = rate.cost;
                        document.getElementById('freteValue').textContent = `R$ ${rate.cost.toFixed(2)}`;
                        break;
                    }
                }
            }
            
            saveData();
        }
        
        function getTotalWithShipping() {
            const productPrice = parseFloat(document.getElementById('productPrice').value) || 0;
            // Aplica desconto do cliente se existir
            const priceAfterDiscount = productPrice - clientDiscount;
            const total = priceAfterDiscount + calculatedShipping + (nightFeeAmount || 0);
            return total > 0 ? total : 0;
        }
        
        // IMPORTANTE: Para planilha, taxas s√£o somadas ao frete
        function getShippingForSpreadsheet() {
            return calculatedShipping + (nightFeeAmount || 0);
        }
        
        function addNightFee(amount) {
            nightFeeAmount = amount;
            nightFeeAdded = true;
            saveData();
        }
        
        function removeNightFee() {
            nightFeeAmount = 0;
            nightFeeAdded = false;
            saveData();
        }
        
        // ============================================
        // CALEND√ÅRIO E HOR√ÅRIOS COM REGRAS DE HOR√ÅRIO
        // ============================================
        function renderCalendar(month, year) {
            const calendar = document.getElementById('calendar');
            const monthYearDisplay = document.getElementById('currentMonthYear');
            
            calendar.innerHTML = '';
            
            const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho",
                              "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            monthYearDisplay.textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const startingDay = firstDay.getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const weekdays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            for (let i = 0; i < 7; i++) {
                const dayHeader = document.createElement('div');
                dayHeader.classList.add('calendar-day-header');
                dayHeader.textContent = weekdays[i];
                calendar.appendChild(dayHeader);
            }
            
            for (let i = 0; i < startingDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('calendar-day', 'disabled');
                calendar.appendChild(emptyDay);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('calendar-day');
                dayElement.textContent = day;
                
                const currentDate = new Date(year, month, day);
                const dateString = currentDate.toISOString().split('T')[0];
                const monthDay = `${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                let isSpecialDate = specialDates.includes(monthDay);
                let isHoliday = holidays.some(h => 
                    h.getDate() === day && h.getMonth() === month && h.getFullYear() === year
                );
                let isAvulsoDate = avulsoDates.includes(dateString);
                let isNoDeliveryDate = noDeliveryDates.some(nd => 
                    nd.getDate() === day && nd.getMonth() === month && nd.getFullYear() === year
                );
                
                if (currentDate < today) {
                    dayElement.classList.add('disabled');
                } else if (isSpecialDate) {
                    dayElement.classList.add('special-day');
                } else if (isHoliday) {
                    dayElement.classList.add('disabled');
                } else if (isNoDeliveryDate) {
                    dayElement.classList.add('disabled');
                }
                
                if (!dayElement.classList.contains('disabled')) {
                    dayElement.addEventListener('click', function() {
                        selectDate(currentDate, isSpecialDate, isHoliday, isNoDeliveryDate, isAvulsoDate);
                    });
                }
                
                if (selectedDate && 
                    selectedDate.getDate() === day && 
                    selectedDate.getMonth() === month && 
                    selectedDate.getFullYear() === year) {
                    dayElement.classList.add('selected');
                }
                
                calendar.appendChild(dayElement);
            }
        }
        
        function selectDate(date, isSpecialDate, isHoliday, isNoDeliveryDate, isAvulsoDate) {
            selectedDate = date;
            
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });
            
            const days = document.querySelectorAll('.calendar-day');
            days.forEach(day => {
                if (parseInt(day.textContent) === date.getDate() && !isNaN(parseInt(day.textContent))) {
                    day.classList.add('selected');
                }
            });
            
            if (isNoDeliveryDate) {
                document.getElementById('noDeliveryMessage').classList.remove('hidden');
                document.getElementById('timeOptions').classList.add('hidden');
                document.getElementById('nextPage2Button').disabled = true;
                return;
            } else {
                document.getElementById('noDeliveryMessage').classList.add('hidden');
                document.getElementById('timeOptions').classList.remove('hidden');
                
                if (currentDeliveryType === 'pickup') {
                    document.getElementById('nextPage2Button').disabled = false;
                } else if (currentDeliveryType === 'delivery' && !isOtherCity) {
                    document.getElementById('nextPage2Button').disabled = true;
                }
            }
            
            const dayOfWeek = date.getDay();
            const optionsContainer = document.getElementById('deliveryOptionsContainer');
            optionsContainer.innerHTML = '';
            
            selectedTime = null;
            selectedTimeLabel = null;
            removeNightFee();
            
            const today = new Date();
            const isToday = date.getDate() === today.getDate() && 
                           date.getMonth() === today.getMonth() && 
                           date.getFullYear() === today.getFullYear();
            
            const now = new Date();
            const currentHour = now.getHours();
            let routes = [];
            let routeType = '';
            
            if (isAvulsoDate) {
                routes = routeTimes.avulso;
                routeType = 'avulso';
            } else if (isSpecialDate) {
                routes = routeTimes.special;
                routeType = 'special';
            } else if (dayOfWeek === 0) {
                routes = routeTimes.sunday;
                routeType = 'sunday';
            } else if (dayOfWeek === 6) {
                routes = routeTimes.saturday;
                routeType = 'saturday';
            } else {
                routes = routeTimes.weekday;
                routeType = 'weekday';
            }
            
            // APLICAR REGRAS DE HOR√ÅRIO
            routes = routes.filter(route => {
                let isRouteAvailable = true;
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinutes = now.getMinutes();
                const currentTimeInMinutes = currentHour * 60 + currentMinutes;
                
                // Se n√£o for hoje, sempre dispon√≠vel
                if (!isToday) return true;
                
                // Regra 1: Segunda a Sexta ap√≥s 17h - encerra primeira rota do dia seguinte
                if (dayOfWeek >= 1 && dayOfWeek <= 5 && currentHour >= 17) {
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    
                    // Se a data selecionada for amanh√£
                    if (date.getDate() === tomorrow.getDate() && 
                        date.getMonth() === tomorrow.getMonth() && 
                        date.getFullYear() === tomorrow.getFullYear()) {
                        
                        // Primeira rota do dia (07:30) fica indispon√≠vel
                        if (route.start === '07:30') {
                            isRouteAvailable = false;
                        }
                    }
                }
                
                // Regra 2: S√°bado ap√≥s 12h - encerra primeira rota de domingo e segunda
                if (dayOfWeek === 6 && currentHour >= 12) {
                    const sunday = new Date(today);
                    sunday.setDate(sunday.getDate() + 1);
                    const monday = new Date(today);
                    monday.setDate(monday.getDate() + 2);
                    
                    // Se for domingo
                    if (date.getDate() === sunday.getDate() && 
                        date.getMonth() === sunday.getMonth()) {
                        
                        // Primeira rota do domingo fica indispon√≠vel
                        if (route.start === '08:00') {
                            isRouteAvailable = false;
                        }
                    }
                    
                    // Se for segunda
                    if (date.getDate() === monday.getDate() && 
                        date.getMonth() === monday.getMonth()) {
                        
                        // Primeira rota da segunda fica indispon√≠vel
                        if (route.start === '07:30') {
                            isRouteAvailable = false;
                        }
                    }
                }
                
                // Regra 3: Feriado ap√≥s 12h - encerra primeira rota do dia seguinte
                if (isHoliday && currentHour >= 12) {
                    const nextDay = new Date(today);
                    nextDay.setDate(nextDay.getDate() + 1);
                    
                    if (date.getDate() === nextDay.getDate() && 
                        date.getMonth() === nextDay.getMonth()) {
                        
                        // Primeira rota do dia seguinte fica indispon√≠vel
                        if (route.start === '07:30' || route.start === '08:00') {
                            isRouteAvailable = false;
                        }
                    }
                }
                
                // Verificar se j√° passou do hor√°rio da rota (para hoje)
                if (isToday) {
                    const [startHour, startMinute] = route.start.split(':').map(Number);
                    const startTimeInMinutes = startHour * 60 + startMinute;
                    
                    // Se j√° passou mais de 30 minutos do in√≠cio da rota
                    if (currentTimeInMinutes > (startTimeInMinutes - 30)) {
                        isRouteAvailable = false;
                    }
                }
                
                return isRouteAvailable;
            });
            
            // Se n√£o houver rotas dispon√≠veis, mostrar mensagem
            if (routes.length === 0) {
                optionsContainer.innerHTML = '<div class="alert alert-warning">N√£o h√° hor√°rios dispon√≠veis para esta data. Por favor, selecione outra data.</div>';
                document.getElementById('nextPage2Button').disabled = true;
                return;
            }
            
            // Renderizar rotas dispon√≠veis
            routes.forEach((route, index) => {
                const routeId = `time${routeType}${index + 1}`;
                const routeElement = document.createElement('div');
                routeElement.classList.add('time-option');
                
                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'deliveryTime';
                input.id = routeId;
                input.value = `${route.start}-${route.end}`;
                input.dataset.label = route.label;
                input.dataset.nightfee = route.nightFee || false;
                input.dataset.fee = route.fee || 0;
                input.dataset.avulsonightfee = route.avulsoNightFee || false;
                
                const label = document.createElement('label');
                label.htmlFor = routeId;
                label.textContent = route.label;
                label.style.cursor = 'pointer';
                label.style.marginLeft = '10px';
                label.style.flex = '1';
                
                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.alignItems = 'center';
                container.appendChild(input);
                container.appendChild(label);
                routeElement.appendChild(container);
                
                input.addEventListener('change', function() {
                    selectedTime = this.value;
                    selectedTimeLabel = this.getAttribute('data-label');
                    
                    const hasNightFee = this.getAttribute('data-nightfee') === 'true';
                    const hasAvulsoNightFee = this.getAttribute('data-avulsonightfee') === 'true';
                    const feeAmount = parseFloat(this.getAttribute('data-fee')) || 0;
                    
                    removeNightFee();
                    
                    if (hasNightFee || hasAvulsoNightFee) {
                        addNightFee(feeAmount);
                    }
                    
                    if (currentDeliveryType === 'pickup') {
                        document.getElementById('nextPage2Button').disabled = false;
                    } else if (currentDeliveryType === 'delivery' && !isOtherCity) {
                        const streetNumber = document.getElementById('streetNumber').value.trim();
                        const neighborhood = document.getElementById('neighborhood').value.trim();
                        
                        if (streetNumber && neighborhood && selectedDate && selectedTime) {
                            document.getElementById('nextPage2Button').disabled = false;
                        }
                    }
                    
                    saveData();
                });
                
                optionsContainer.appendChild(routeElement);
            });
            
            saveData();
        }
        
        function resetCalendar() {
            document.getElementById('noDeliveryMessage').classList.add('hidden');
            document.getElementById('timeOptions').classList.add('hidden');
            selectedDate = null;
            selectedTime = null;
            selectedTimeLabel = null;
            removeNightFee();
            
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });
            
            document.getElementById('nextPage2Button').disabled = true;
            saveData();
        }
        
        // ============================================
        // REVIS√ÉO DE DADOS COM TAXAS SEPARADAS
        // ============================================
        function updateReviewData() {
            const reviewDiv = document.getElementById('reviewData');
            const totalSection = document.getElementById('finalTotalSection');
            const totalDetails = document.getElementById('finalTotalDetails');
            
            let html = '';
            let totalHtml = '';
            
            const formatCurrency = (value) => {
                return parseFloat(value || 0).toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                });
            };
            
            const formatDate = (date) => {
                return date.toLocaleDateString('pt-BR', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
            };
            
            // Produto
            html += '<div class="review-item">';
            html += '<div class="review-label">Produto</div>';
            html += `<div class="review-value">${document.getElementById('productName').value}</div>`;
            html += '</div>';
            
            // Valores
            const productPrice = parseFloat(document.getElementById('productPrice').value) || 0;
            const finalTotal = getTotalWithShipping();
            
            html += '<div class="review-item">';
            html += '<div class="review-label">Valor do Produto</div>';
            html += `<div class="review-value">${formatCurrency(productPrice)}</div>`;
            html += '</div>';
            
            // Desconto (se houver)
            if (clientDiscount > 0) {
                html += '<div class="review-item" style="color: var(--success);">';
                html += '<div class="review-label">Desconto</div>';
                html += `<div class="review-value">- ${formatCurrency(clientDiscount)}</div>`;
                html += '</div>';
            }
            
            // Frete
            const deliveryType = document.querySelector('input[name="deliveryType"]:checked')?.value;
            if (deliveryType === 'delivery' && !isOtherCity && calculatedShipping > 0) {
                html += '<div class="review-item">';
                html += '<div class="review-label">Frete</div>';
                html += `<div class="review-value">${formatCurrency(calculatedShipping)}</div>`;
                html += '</div>';
            }
            
            // Taxas adicionais (mostradas separadamente na revis√£o)
            if (nightFeeAdded) {
                html += '<div class="review-item">';
                html += '<div class="review-label taxa-label">Taxa Noturna/Domingo</div>';
                html += `<div class="review-value taxa-item">${formatCurrency(nightFeeAmount)}</div>`;
                html += '</div>';
                
                // Adiciona descri√ß√£o da taxa
                if (selectedTimeLabel) {
                    html += '<div class="review-item" style="font-size: 12px; color: #666;">';
                    html += '<div class="review-label"></div>';
                    html += `<div class="review-value">(${selectedTimeLabel})</div>`;
                    html += '</div>';
                }
            }
            
            // Dados pessoais
            html += '<div class="review-item">';
            html += '<div class="review-label">Comprador</div>';
            html += `<div class="review-value">${document.getElementById('buyerName').value} - ${document.getElementById('buyerPhone').value}</div>`;
            html += '</div>';
            
            html += '<div class="review-item">';
            html += '<div class="review-label">Presenteado</div>';
            html += `<div class="review-value">${document.getElementById('giftedName').value}`;
            if (document.getElementById('giftedPhone').value) {
                html += ` - ${document.getElementById('giftedPhone').value}`;
            }
            html += '</div>';
            html += '</div>';
            
            // Entrega
            html += '<div class="review-item">';
            html += '<div class="review-label">Entrega</div>';
            if (deliveryType === 'pickup') {
                html += '<div class="review-value">Retirada na loja (S√£o Geraldo - BH)</div>';
            } else if (isOtherCity) {
                html += '<div class="review-value">Outra cidade (prazo a confirmar)</div>';
            } else {
                html += `<div class="review-value">${document.getElementById('streetNumber').value}`;
                if (document.getElementById('complement').value) {
                    html += ` - ${document.getElementById('complement').value}`;
                }
                html += ` - ${document.getElementById('neighborhood').value}`;
                if (selectedCity) {
                    html += ` - ${selectedCity}`;
                }
                html += '</div>';
            }
            html += '</div>';
            
            // Data e hor√°rio
            if (selectedDate) {
                html += '<div class="review-item">';
                html += '<div class="review-label">Data e Hor√°rio</div>';
                html += `<div class="review-value">${formatDate(selectedDate)} - ${selectedTimeLabel || 'A definir'}</div>`;
                html += '</div>';
            }
            
            // Cart√£o
            const sendCard = document.querySelector('input[name="sendCard"]:checked')?.value;
            if (sendCard === 'yes') {
                html += '<div class="review-item">';
                html += '<div class="review-label">Cart√£o</div>';
                html += `<div class="review-value">${document.getElementById('cardMessage').value.substring(0, 50)}...</div>`;
                html += '</div>';
            }
            
            reviewDiv.innerHTML = html;
            
            // Total
            totalHtml += '<div class="total-item">';
            totalHtml += '<span>Produto:</span>';
            totalHtml += `<span>${formatCurrency(productPrice)}</span>`;
            totalHtml += '</div>';
            
            if (clientDiscount > 0) {
                totalHtml += '<div class="total-item" style="color: var(--success);">';
                totalHtml += '<span>Desconto:</span>';
                totalHtml += `<span>- ${formatCurrency(clientDiscount)}</span>`;
                totalHtml += '</div>';
            }
            
            if (deliveryType === 'delivery' && !isOtherCity && calculatedShipping > 0) {
                totalHtml += '<div class="total-item">';
                totalHtml += '<span>Frete:</span>';
                totalHtml += `<span>${formatCurrency(calculatedShipping)}</span>`;
                totalHtml += '</div>';
            }
            
            if (nightFeeAdded) {
                totalHtml += '<div class="total-item">';
                totalHtml += '<span>Taxa noturna/domingo:</span>';
                totalHtml += `<span>${formatCurrency(nightFeeAmount)}</span>`;
                totalHtml += '</div>';
            }
            
            totalHtml += '<div class="total-item total-final">';
            totalHtml += '<span><strong>TOTAL:</strong></span>';
            totalHtml += `<span><strong>${formatCurrency(finalTotal)}</strong></span>`;
            totalHtml += '</div>';
            
            totalDetails.innerHTML = totalHtml;
            totalSection.classList.remove('hidden');
        }
        
        // ============================================
        // SISTEMA DE ENVIO PARA PLANILHA
        // ============================================
        function prepareExcelData() {
            const now = new Date();
            const formattedDateTime = `${now.getDate().toString().padStart(2, '0')}/` +
                                     `${(now.getMonth() + 1).toString().padStart(2, '0')}/` +
                                     `${now.getFullYear()} ` +
                                     `${now.getHours().toString().padStart(2, '0')}:` +
                                     `${now.getMinutes().toString().padStart(2, '0')}`;
            
            const productName = document.getElementById('productName').value;
            const productPrice = parseFloat(document.getElementById('productPrice').value) || 0;
            const buyerName = document.getElementById('buyerName').value;
            const buyerPhone = document.getElementById('buyerPhone').value;
            const giftedName = document.getElementById('giftedName').value;
            const giftedPhone = document.getElementById('giftedPhone').value;
            const deliveryType = document.querySelector('input[name="deliveryType"]:checked')?.value;
            const anonymous = document.querySelector('input[name="anonymous"]:checked')?.value;
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
            const foundUs = document.querySelector('input[name="foundUs"]:checked')?.value;
            const sendCard = document.querySelector('input[name="sendCard"]:checked')?.value;
            const cardMessage = document.getElementById('cardMessage').value || '';
            
            // Aplica desconto para c√°lculo na planilha
            const finalPrice = productPrice - clientDiscount;
            const formattedPrice = finalPrice.toFixed(2).replace('.', ',');
            
            // IMPORTANTE: Frete + taxas juntos para a planilha
            const totalShipping = getShippingForSpreadsheet();
            const formattedShipping = totalShipping.toFixed(2).replace('.', ',');
            
            let streetNumber = '';
            let complement = '';
            let neighborhood = '';
            let city = '';
            let reference = '';
            
            if (deliveryType === 'delivery' && !isOtherCity) {
                streetNumber = document.getElementById('streetNumber').value;
                complement = document.getElementById('complement').value || '';
                neighborhood = document.getElementById('neighborhood').value;
                city = selectedCity;
                reference = document.getElementById('referencePoint').value || '';
            }
            
            let deliveryDate = '';
            if (selectedDate) {
                const days = ['Domingo', 'Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'S√°bado'];
                const dayName = days[selectedDate.getDay()];
                deliveryDate = `${selectedDate.getDate().toString().padStart(2, '0')}/` +
                              `${(selectedDate.getMonth() + 1).toString().padStart(2, '0')}/` +
                              `${selectedDate.getFullYear()} - ${dayName}`;
            }
            
            const sendCardText = sendCard === 'yes' ? 'Sim' : 'N√£o';
            const anonymousText = anonymous === 'yes' ? 'ANONIMO' : 'Sim';
            
            let paymentText = '';
            if (paymentMethod === 'pix') {
                paymentText = 'PIX direto para nosso CNPJ? (Vamos te enviar o link)';
            } else if (paymentMethod === 'creditCard') {
                paymentText = 'Link de Cart√£o Cr√©dito online (vamos te enviar o link)';
            }
            
            const data = new Array(50).fill('');
            
            data[0] = formattedDateTime;
            data[1] = buyerName;
            data[2] = buyerPhone;
            data[3] = productName;
            data[4] = formattedPrice; // Pre√ßo com desconto aplicado
            data[5] = formattedShipping; // Frete + taxas juntos
            data[6] = 'FORMUL√ÅRIO MANUAL';
            data[7] = '';
            data[8] = giftedName;
            data[9] = giftedPhone;
            data[10] = streetNumber;
            data[11] = complement;
            data[12] = neighborhood;
            data[13] = city;
            data[14] = reference;
            data[15] = deliveryDate;
            data[16] = selectedTimeLabel || '';
            data[17] = sendCardText;
            
            if (sendCard === 'yes') {
                data[18] = cardMessage.replace(/\n/g, ' ');
            }
            
            data[46] = foundUs || '';
            data[48] = anonymousText;
            data[32] = paymentText;
            
            return data;
        }
        
        async function submitForm() {
            if (isSubmitting) return;
            
            if (!validateForm()) {
                mostrarStatus('‚ùå Por favor, corrija os erros no formul√°rio.', 'error');
                return;
            }
            
            // Se veio de um link compartilhado, marcar como usado
            if (!isAdminMode && window.currentOrderId) {
                const usedLinks = JSON.parse(localStorage.getItem('usedLinks') || '[]');
                usedLinks.push(window.currentOrderId);
                localStorage.setItem('usedLinks', JSON.stringify(usedLinks));
                console.log('üìù Link marcado como usado:', window.currentOrderId);
            }
            
            const submitBtn = document.getElementById('submitButton');
            const loadingSection = document.getElementById('loadingSection');
            
            submitBtn.disabled = true;
            isSubmitting = true;
            loadingSection.style.display = 'block';
            
            mostrarStatus('‚è≥ Preparando envio dos dados...', 'info');
            
            try {
                const excelData = prepareExcelData();
                console.log('üì¶ Dados para envio:', excelData);
                console.log('üí∞ Frete + Taxas para planilha:', getShippingForSpreadsheet());
                
                const result = await enviarDadosParaPlanilha(excelData);
                
                if (result.success) {
                    mostrarStatus(`‚úÖ ${result.message}`, 'success');
                    
                    submitBtn.innerHTML = '‚úÖ ENVIADO';
                    submitBtn.classList.add('btn-success');
                    
                    setTimeout(() => {
                        // Mostrar p√°gina de sucesso baseada no m√©todo de pagamento
                        document.getElementById('page4').classList.remove('active');
                        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
                        
                        if (paymentMethod === 'pix') {
                            document.getElementById('thankYouPagePix').classList.add('active');
                            showPaymentConfirmation('pix');
                        } else {
                            document.getElementById('thankYouPageCard').classList.add('active');
                            showPaymentConfirmation('card');
                        }
                        
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 1000);
                    
                    setTimeout(() => {
                        clearSavedData();
                    }, 5000);
                    
                } else {
                    throw new Error(result.message || 'Erro desconhecido');
                }
                
            } catch (error) {
                console.error('‚ùå Erro no envio:', error);
                mostrarStatus(`‚ùå Erro: ${error.message || 'Falha na conex√£o'}`, 'error');
                submitBtn.disabled = false;
                isSubmitting = false;
            } finally {
                loadingSection.style.display = 'none';
            }
        }
        
        async function enviarDadosParaPlanilha(dados) {
            try {
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(WEB_APP_URL)}`;
                
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'inserir_pedido',
                        senha: CORRECT_PASSWORD,
                        dados: dados
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üì¶ Resposta:', data);
                
                return {
                    success: data.status === 'sucesso',
                    message: data.message || 'Dados enviados com sucesso!'
                };
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                
                try {
                    const resultAlt = await enviarDadosAlternativo(dados);
                    return resultAlt;
                } catch (altError) {
                    throw altError;
                }
            }
        }
        
        async function enviarDadosAlternativo(dados) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log('‚ö†Ô∏è M√©todo alternativo:', dados);
                    resolve({
                        success: true,
                        message: 'Dados enviados - Verifique a planilha'
                    });
                }, 1500);
            });
        }
        
        function mostrarStatus(message, type = 'info') {
            const statusBox = document.getElementById('statusBox');
            const sendStatus = document.getElementById('sendStatus');
            
            statusBox.className = 'status-box';
            sendStatus.className = 'status-box hidden';
            
            let statusClass = 'status-info';
            if (type === 'success') statusClass = 'status-success';
            if (type === 'error') statusClass = 'status-error';
            
            statusBox.classList.add(statusClass);
            statusBox.innerHTML = message;
            statusBox.style.display = 'block';
            
            sendStatus.classList.add(statusClass);
            sendStatus.innerHTML = message;
            sendStatus.classList.remove('hidden');
            
            if (type !== 'error') {
                setTimeout(() => {
                    statusBox.style.display = 'none';
                    sendStatus.classList.add('hidden');
                }, type === 'success' ? 5000 : 3000);
            }
        }
        
        // ============================================
        // P√ÅGINA DE SUCESSO E PAGAMENTO
        // ============================================
        function showPaymentConfirmation(paymentType) {
            const total = getTotalWithShipping();
            const buyerName = document.getElementById('buyerName').value;
            
            const formatCurrency = (value) => {
                return parseFloat(value || 0).toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                });
            };
            
            let html = '';
            
            html += '<div class="review-item">';
            html += '<div class="review-label">Cliente</div>';
            html += `<div class="review-value">${buyerName}</div>`;
            html += '</div>';
            
            html += '<div class="review-item">';
            html += '<div class="review-label">Produto</div>';
            html += `<div class="review-value">${document.getElementById('productName').value}</div>`;
            html += '</div>';
            
            const productPrice = parseFloat(document.getElementById('productPrice').value) || 0;
            html += '<div class="review-item">';
            html += '<div class="review-label">Valor Original</div>';
            html += `<div class="review-value">${formatCurrency(productPrice)}</div>`;
            html += '</div>';
            
            // Mostrar desconto se existir
            if (clientDiscount > 0) {
                html += '<div class="review-item" style="color: var(--success);">';
                html += '<div class="review-label">Desconto</div>';
                html += `<div class="review-value">- ${formatCurrency(clientDiscount)}</div>`;
                html += '</div>';
            }
            
            // Frete + taxas juntos na exibi√ß√£o tamb√©m
            const totalShipping = getShippingForSpreadsheet();
            if (totalShipping > 0) {
                html += '<div class="review-item">';
                html += '<div class="review-label">Frete + Taxas</div>';
                html += `<div class="review-value">${formatCurrency(totalShipping)}</div>`;
                html += '</div>';
            }
            
            html += '<div class="review-item total-final">';
            html += '<div class="review-label"><strong>TOTAL</strong></div>';
            html += `<div class="review-value"><strong>${formatCurrency(total)}</strong></div>`;
            html += '</div>';
            
            if (paymentType === 'pix') {
                document.getElementById('paymentDetailsPix').innerHTML = html;
            } else {
                document.getElementById('paymentDetailsCard').innerHTML = html;
            }
        }
        
        function selectPixKey() {
            const pixKeyElement = document.getElementById('pixKey');
            const range = document.createRange();
            range.selectNodeContents(pixKeyElement);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        }
        
        function copyPixKey() {
            const pixKey = PIX_KEY;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(pixKey).then(() => {
                    mostrarStatus('‚úÖ Chave PIX copiada!', 'success');
                });
            } else {
                const textArea = document.createElement('textarea');
                textArea.value = pixKey;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                mostrarStatus('‚úÖ Chave PIX copiada!', 'success');
            }
        }
        
        function sendWhatsAppMessage() {
            const buyerName = document.getElementById('buyerName').value;
            const buyerPhone = document.getElementById('buyerPhone').value;
            const productName = document.getElementById('productName').value;
            const productPrice = parseFloat(document.getElementById('productPrice').value) || 0;
            const total = getTotalWithShipping();
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
            const deliveryType = document.querySelector('input[name="deliveryType"]:checked')?.value;
            
            let message = `*NOVO PEDIDO - Mundo Carol*%0A%0A`;
            message += `*Cliente:* ${buyerName}%0A`;
            message += `*Telefone:* ${buyerPhone}%0A`;
            message += `*Produto:* ${productName}%0A`;
            message += `*Valor:* R$ ${productPrice.toFixed(2)}%0A`;
            
            if (clientDiscount > 0) {
                message += `*Desconto:* -R$ ${clientDiscount.toFixed(2)}%0A`;
            }
            
            const totalShipping = getShippingForSpreadsheet();
            if (totalShipping > 0) {
                message += `*Frete + Taxas:* R$ ${totalShipping.toFixed(2)}%0A`;
            }
            
            message += `*TOTAL:* R$ ${total.toFixed(2)}%0A`;
            message += `*Tipo de entrega:* ${deliveryType === 'pickup' ? 'Retirada na loja' : 'Entrega'}%0A`;
            message += `*Pagamento:* ${paymentMethod === 'pix' ? 'PIX' : 'Cart√£o'}%0A%0A`;
            message += `Formul√°rio enviado com sucesso!`;
            
            const phone = WHATSAPP_NUMBER;
            window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
        }
        
        // ============================================
        // SALVAR E CARREGAR DADOS
        // ============================================
        function saveData() {
            const formData = {
                productName: document.getElementById('productName').value,
                productPrice: document.getElementById('productPrice').value,
                productDiscount: document.getElementById('productDiscount').value,
                buyerName: document.getElementById('buyerName').value,
                buyerPhone: document.getElementById('buyerPhone').value,
                giftedName: document.getElementById('giftedName').value,
                giftedPhone: document.getElementById('giftedPhone').value,
                anonymous: document.querySelector('input[name="anonymous"]:checked')?.value,
                deliveryType: document.querySelector('input[name="deliveryType"]:checked')?.value,
                deliveryCity: document.getElementById('deliveryCity').value,
                streetNumber: document.getElementById('streetNumber').value,
                complement: document.getElementById('complement').value,
                neighborhood: document.getElementById('neighborhood').value,
                referencePoint: document.getElementById('referencePoint').value,
                selectedCity: selectedCity,
                calculatedShipping: calculatedShipping,
                selectedDate: selectedDate ? selectedDate.toISOString() : null,
                selectedTime: selectedTime,
                selectedTimeLabel: selectedTimeLabel,
                nightFeeAdded: nightFeeAdded,
                nightFeeAmount: nightFeeAmount,
                sendCard: document.querySelector('input[name="sendCard"]:checked')?.value,
                cardMessage: document.getElementById('cardMessage').value,
                signedCard: document.querySelector('input[name="signedCard"]:checked')?.value,
                paymentMethod: document.querySelector('input[name="paymentMethod"]:checked')?.value,
                foundUs: document.querySelector('input[name="foundUs"]:checked')?.value,
                confirmData: document.getElementById('confirmData').checked
            };
            
            localStorage.setItem('mundoCarolFormData', JSON.stringify(formData));
        }
        
        function loadSavedData() {
            // S√≥ carrega dados salvos se for modo administrador
            if (!isAdminMode) return;
            
            const savedData = localStorage.getItem('mundoCarolFormData');
            if (!savedData) return;
            
            try {
                const data = JSON.parse(savedData);
                
                // S√≥ preenche se for modo admin e n√£o tiver sido pr√©-carregado
                if (isAdminMode && !document.getElementById('productName').disabled) {
                    document.getElementById('productName').value = data.productName || '';
                    document.getElementById('productPrice').value = data.productPrice || '';
                    document.getElementById('productDiscount').value = data.productDiscount || '0';
                }
                
                document.getElementById('buyerName').value = data.buyerName || '';
                document.getElementById('buyerPhone').value = data.buyerPhone || '';
                document.getElementById('giftedName').value = data.giftedName || '';
                document.getElementById('giftedPhone').value = data.giftedPhone || '';
                document.getElementById('deliveryCity').value = data.deliveryCity || '';
                document.getElementById('streetNumber').value = data.streetNumber || '';
                document.getElementById('complement').value = data.complement || '';
                document.getElementById('neighborhood').value = data.neighborhood || '';
                document.getElementById('referencePoint').value = data.referencePoint || '';
                document.getElementById('cardMessage').value = data.cardMessage || '';
                document.getElementById('confirmData').checked = data.confirmData || false;
                
                if (data.confirmData) {
                    document.getElementById('submitButton').disabled = false;
                }
                
                selectedCity = data.selectedCity || '';
                calculatedShipping = data.calculatedShipping || 0;
                nightFeeAdded = data.nightFeeAdded || false;
                nightFeeAmount = data.nightFeeAmount || 0;
                currentDeliveryType = data.deliveryType || '';
                
                const radios = [
                    { name: 'anonymous', value: data.anonymous },
                    { name: 'deliveryType', value: data.deliveryType },
                    { name: 'sendCard', value: data.sendCard },
                    { name: 'signedCard', value: data.signedCard },
                    { name: 'paymentMethod', value: data.paymentMethod },
                    { name: 'foundUs', value: data.foundUs }
                ];
                
                radios.forEach(radio => {
                    if (radio.value) {
                        const element = document.querySelector(`input[name="${radio.name}"][value="${radio.value}"]`);
                        if (element) element.checked = true;
                    }
                });
                
                if (data.sendCard === 'yes') {
                    document.getElementById('acknowledgeTermsYes').checked = true;
                }
                
                if (data.selectedDate) {
                    selectedDate = new Date(data.selectedDate);
                    selectedTime = data.selectedTime;
                    selectedTimeLabel = data.selectedTimeLabel;
                    
                    currentMonth = selectedDate.getMonth();
                    currentYear = selectedDate.getFullYear();
                }
                
                calculateProductTotal();
                if (selectedCity && selectedCity !== 'other' && currentDeliveryType === 'delivery') {
                    calculateShipping();
                }
                
                if (currentDeliveryType) {
                    updateDeliveryTypeDisplay();
                }
                
                if (selectedCity) {
                    updateCityDisplay();
                }
                
            } catch (e) {
                console.error('Erro ao carregar dados:', e);
            }
        }
        
        function clearSavedData() {
            // N√£o limpa se for modo cliente
            if (!isAdminMode) return;
            
            localStorage.removeItem('mundoCarolFormData');
            
            selectedDate = null;
            selectedTime = null;
            selectedTimeLabel = null;
            currentMonth = new Date().getMonth();
            currentYear = new Date().getFullYear();
            originalTotal = 0;
            nightFeeAdded = false;
            nightFeeAmount = 0;
            isOtherCity = false;
            calculatedShipping = 0;
            selectedCity = '';
            currentDeliveryType = '';
            clientDiscount = 0;
        }
        
        function validateForm() {
            return validatePage1() && validatePage2() && validatePage3() && validatePage4();
        }
    </script>
</body>
</html>


